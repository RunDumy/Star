[build]
  builder = "NIXPACKS"

[deploy]
  startCommand = "gunicorn --threads 4 -b 0.0.0.0:$PORT app:app"
  healthcheckPath = "/api/health"
  healthcheckTimeout = 300
  restartPolicyType = "ON_FAILURE"
  restartPolicyMaxRetries = 10

[[services]]
  id = "star-backend"
  name = "star-backend"
  source = { repo = "github.com/RunDumy/Star", path = "star-backend/star_backend_flask" }
  instanceCount = 1
  instanceSizeSlug = "CPU_0.5"

  [services.http]
    port = 5000
    forceHttps = true

  [[services.env]]
    key = "PYTHON_VERSION"
    value = "3.13.4"

  [[services.env]]
    key = "PORT"
    value = "5000"

  [[services.env]]
    key = "AGORA_APP_ID"
    value = "${{shared.AGORA_APP_ID}}"

  [[services.env]]
    key = "AGORA_APP_CERTIFICATE"
    value = "${{shared.AGORA_APP_CERTIFICATE}}"

  [[services.env]]
    key = "REDIS_URL"
    value = "${{shared.REDIS_URL}}"

  [[services.env]]
    key = "SUPABASE_URL"
    value = "${{shared.SUPABASE_URL}}"

  [[services.env]]
    key = "SUPABASE_ANON_KEY"
    value = "${{shared.SUPABASE_ANON_KEY}}"

  [[services.env]]
    key = "SECRET_KEY"
    value = "${{shared.SECRET_KEY}}"

  [[services.env]]
    key = "JWT_SECRET"
    value = "${{shared.JWT_SECRET}}"

  [[services.env]]
    key = "JWT_ALGORITHM"
    value = "HS256"

  [[services.env]]
    key = "ALLOWED_ORIGINS"
    value = "https://star-frontend.vercel.app,http://localhost:3000"

  [[services.env]]
    key = "SPOTIPY_CLIENT_ID"
    value = "${{shared.SPOTIPY_CLIENT_ID}}"

  [[services.env]]
    key = "SPOTIPY_CLIENT_SECRET"
    value = "${{shared.SPOTIPY_CLIENT_SECRET}}"