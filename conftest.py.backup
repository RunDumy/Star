import sys
import os
import pytest
from types import ModuleType
from star_backend_flask.database import db
import unittest.mock as mock

# Mock local modules to prevent import errors when main imports them
m_birth = ModuleType('birth_chart')
m_birth.calculate_birth_chart = lambda *a, **k: {}
m_birth.geocode_location = lambda *a, **k: {'lat': 0, 'lng': 0}
sys.modules['birth_chart'] = m_birth

m_sigil = ModuleType('sigil_generator')
m_sigil.sigil_bp = None
sys.modules['sigil_generator'] = m_sigil

m_tarot = ModuleType('tarot_interactions')
m_tarot.tarot_bp = None
sys.modules['tarot_interactions'] = m_tarot

m_feed = ModuleType('feed')
m_feed.feed = None
sys.modules['feed'] = m_feed

m_agora = ModuleType('agora_token_builder')
m_agora.Role_Attendee = None
m_agora.Role_Publisher = None
m_agora.RtcTokenBuilder = None
sys.modules['agora_token_builder'] = m_agora

from star_backend_flask.main import create_app


@pytest.fixture
def client():
    app = create_app()
    app.config['TESTING'] = True
    with app.app_context():
        db.create_all()
    return app.test_client()


@pytest.fixture
def app_client():
    app = create_app()
    app.config['TESTING'] = True
    return app.test_client()


@pytest.fixture
def mock_token():
    return 'mock_token'


@pytest.fixture(autouse=True)
def mock_cosmos_db():
    """Mock Cosmos DB containers for testing"""
    mock_container = mock.MagicMock()
    
    # Mock query_items for SELECT operations - return test data
    mock_container.query_items.return_value = [
        {'id': '1', 'username': 'testuser', 'zodiac_sign': 'Aries', 'password_hash': 'hashed_password'}
    ]
    
    # Mock create_item for INSERT operations
    mock_container.create_item.return_value = None
    
    # Mock upsert_item for UPDATE operations
    mock_container.upsert_item.return_value = None
    
    # Mock the containers used in the application
    with mock.patch('star_backend_flask.main.users_container', mock_container), \
         mock.patch('star_backend_flask.main.posts_container', mock_container), \
         mock.patch('star_backend_flask.main.likes_container', mock_container), \
         mock.patch('star_backend_flask.main.comments_container', mock_container), \
         mock.patch('star_backend_flask.main.user_actions_container', mock_container), \
         mock.patch('star_backend_flask.main.engagements_container', mock_container), \
         mock.patch('star_backend_flask.star_auth.users_container', mock_container):
        yield
